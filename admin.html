<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mannskapsbok – Admin</title>
  <link rel="stylesheet" href="./assets/styles.css?v=layout1">
  <style>
    /* header/nav (isolert) */
    .rk-header{background:#fff;border-bottom:1px solid #eaeaea}
    .rk-head-inner{display:flex;align-items:center;gap:14px;padding:10px 0}
    .rk-logo{position:relative;width:42px;height:42px;flex:0 0 42px}
    .rk-logo::before,.rk-logo::after{content:"";position:absolute;background:#ff1a1a;border-radius:2px}
    .rk-logo::before{width:70%;height:26%;left:15%;top:37%}
    .rk-logo::after{width:26%;height:70%;left:37%;top:15%}
    .rk-title{font-size:28px;font-weight:800;letter-spacing:.2px;color:#000}
    .rk-title .rk-sub{font-weight:600;margin-left:.25em}
    .rk-nav{background:#ff1a1a}
    .rk-nav .wrap{display:flex;gap:12px;padding:6px 0;font-weight:700}
    .rk-nav a{color:#fff;text-decoration:none}
    .rk-nav a:hover{text-decoration:underline}
    .rk-header + .rk-nav + .wrap{margin-top:16px}

    /* layout */
    .shell{max-width:1100px;margin:0 auto}
    .admin-grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:980px){ .admin-grid{grid-template-columns:1fr} }

    /* modaler */
    .modal{
      position:fixed;inset:0;background:rgba(2,6,23,.48);
      display:none;align-items:center;justify-content:center;z-index:60;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(1000px,92vw);max-height:90vh;overflow:auto;background:#fff;
      border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)
    }
    .modal-hd{padding:14px 16px;background:#f8fafc;border-bottom:1px solid var(--line);font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .modal-bd{padding:14px 16px}

    /* små indikatorer */
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
    .dot{width:8px;height:8px;border-radius:50%;background:#d1d5db}
    .dot.on{background:#2563eb}
  </style>
</head>
<body>

<div class="rk-header">
  <div class="wrap rk-head-inner">
    <div class="rk-logo"></div>
    <div class="rk-title">Røde Kors<span class="rk-sub">Båten Bjørgvin</span></div>
  </div>
</div>
<nav class="rk-nav">
  <div class="wrap">
    <a href="./elev.html">Hovedmeny</a>
  </div>
</nav>

<div class="wrap shell">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h1 style="margin:0">Admin</h1>
    <div class="row">
      <button id="btnOpenLog" class="btn small">Logg</button>
      <button id="btnOpenCatalog" class="btn small primary">Katalog punkter</button>
    </div>
  </div>

  <div class="admin-grid" id="app">
    <!-- venstre -->
    <div>
      <div class="box">
        <div class="hd">Velg bruker</div>
        <div class="bd">
          <input id="userSearch" class="field" placeholder="Søk navn/epost …" style="width:100%;margin-bottom:10px">
          <ul id="userList" class="list"></ul>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="hd">Handlinger for valgt bruker</div>
        <div class="bd">
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button id="btnMakeAdmin" class="btn small">Gjør til admin</button>
            <button id="btnRemoveAdmin" class="btn small">Fjern admin</button>
            <button id="btnDeleteUser" class="btn small">Slett bruker</button>
          </div>
        </div>
      </div>
    </div>

    <!-- høyre -->
    <div>
      <div class="box">
        <div class="hd"><span id="selHdr">Punkter til elev</span></div>
        <div class="bd" id="userBook"><div class="note">Velg en bruker til venstre.</div></div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="hd">Kommentar til eleven</div>
        <div class="bd">
          <div class="row" style="gap:8px">
            <input id="commentTxt" class="field" placeholder="Skriv kommentar …" style="flex:1;min-width:240px">
            <button id="addComment" class="btn small">Legg til</button>
          </div>
          <ul id="commentList" class="list" style="margin-top:8px;max-height:240px"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- KATALOG-MODAL -->
<div class="modal" id="catModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-hd">
      <span>Katalog – rediger punkter</span>
      <div class="row" style="gap:8px">
        <select id="catRole" class="field" style="min-width:180px"></select>
        <button id="catClose" class="btn small">Lukk</button>
      </div>
    </div>
    <div class="modal-bd">
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <button id="addSec" class="btn small primary">+ Inndeling</button>
      </div>
      <div id="catWrap"></div>
    </div>
  </div>
</div>

<!-- EKSEMPEL-EDITOR (for ett punkt) -->
<div class="modal" id="exModal" aria-hidden="true">
  <div class="modal-card" style="width:min(720px,92vw)">
    <div class="modal-hd">
      <span>Eksempel / forklaring</span>
      <button id="exClose" class="btn small">Lukk</button>
    </div>
    <div class="modal-bd">
      <div class="row" style="gap:10px;align-items:center;margin-bottom:8px">
        <label class="pill"><span class="dot" id="exDot"></span> <input id="exToggle" type="checkbox" style="margin-left:6px"> Aktiver eksempel for dette punktet</label>
      </div>
      <textarea id="exText" class="field" style="width:100%;min-height:200px" placeholder="Skriv detaljert forklaring / eksempel …"></textarea>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="exSave" class="btn primary">Lagre</button>
      </div>
    </div>
  </div>
</div>

<!-- LOGG-MODAL (liten) -->
<div class="modal" id="logModal" aria-hidden="true">
  <div class="modal-card" style="width:min(680px,92vw)">
    <div class="modal-hd">
      <span>Systemlogg</span>
      <button id="logClose" class="btn small">Lukk</button>
    </div>
    <div class="modal-bd">
      <div id="logList">Laster …</div>
    </div>
  </div>
</div>

<script type="module">
import {
  sb, ROLES,
  ensureUserOrRedirect,
  listUsers, loadCatalog, loadProgressFor, loadComments, loadLogs,
  upsertProgress, addComment,
  addSection, updateSectionTitle, moveSection, deleteSection,
  addItem, editItem, deleteItem, moveItem,
  setItemExample, setUserAdmin
} from "./assets/common.js?v=layout1";

(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;"}[m]));
  const today=()=>new Date().toISOString().slice(0,10);

  let me=null, users=[], catalog={}, selUserId=null, selUserProg=new Map();
  let exItemId=null; // for eksempel-editor

  async function init(){
    me = await ensureUserOrRedirect();
    const { data:prof } = await sb.from("profiles").select("is_admin").eq("id", me.id).single();
    if(!prof?.is_admin){
      document.getElementById('app').innerHTML = '<div class="box"><div class="hd">Ingen tilgang</div><div class="bd">Denne siden er bare for administratorer.</div></div>';
      return;
    }
    [users, catalog] = await Promise.all([listUsers(), loadCatalog()]);
    renderUsers();
    fillRoleSelect();
    bindTopButtons();
  }

  /* ---------- Brukerlisten ---------- */
  function renderUsers(){
    const list = $('#userList');
    const q = ($('#userSearch').value||'').toLowerCase();
    const arr = users.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
    if(!arr.length){ list.innerHTML='<li><span class="note">Ingen brukere</span></li>'; return; }

    list.innerHTML = arr.map(u=>`
      <li data-id="${u.id}">
        <div>
          <div><b>${esc(u.name||u.email||u.id)}</b></div>
          <div class="note">${esc(u.email||'')}</div>
        </div>
        <span class="badge" id="sum-${u.id}">…</span>
      </li>
    `).join('');

    $$('#userList li').forEach(li => li.onclick = ()=> selectUser(li.getAttribute('data-id')));

    // fyll små summer
    arr.forEach(async u=>{
      const map = await loadProgressFor(u.id);
      const total = Object.values(catalog).flatMap(secs=>secs.flatMap(s=>s.items)).length;
      let done=0; for(const v of map.values()) if(v?.done) done++;
      const chip = $(`#sum-${u.id}`); if(chip) chip.textContent = `${done}/${total}`;
    });

    $('#userSearch').oninput = renderUsers;
  }

  async function selectUser(uid){
    selUserId = uid;
    const u = users.find(x=>x.id===uid);
    selUserProg = await loadProgressFor(uid);
    $('#selHdr').textContent = u?.name || u?.email || 'Punkter til elev';
    await renderUserBook(uid);
    await drawComments(uid);

    $('#btnDeleteUser').onclick = ()=> deleteUser(uid);
    $('#btnMakeAdmin').onclick = async ()=>{ await setUserAdmin(uid,true); toast('Satt som admin'); };
    $('#btnRemoveAdmin').onclick = async ()=>{ await setUserAdmin(uid,false); toast('Fjernet admin'); };
  }

  async function renderUserBook(uid){
    const html = ROLES.map(role=>{
      const secs=catalog[role]||[];
      if(!secs.length) return '';
      return `
        <div class="box" style="margin-bottom:12px">
          <div class="hd">${role}</div>
          <div class="bd">
            <table>
              <thead><tr><th style="width:56px">#</th><th>Beskrivelse</th><th style="width:90px">Avkryss</th><th style="width:240px">Sjekket ut av</th><th style="width:160px">Dato</th></tr></thead>
              <tbody>
                ${secs.map((s,si)=> s.items.map((it,ii)=>{
                  const key = String(it.id);
                  const pr  = selUserProg.get(key)||{};
                  return `
                    <tr data-id="${key}">
                      <td>${si+1}.${ii+1}</td>
                      <td>
                        ${esc(it.text)}
                        ${it.has_example ? `<span class="pill" style="margin-left:6px"><span class="dot on"></span> Eksempel</span>`:''}
                      </td>
                      <td style="text-align:center">
                        <button class="mini-check" data-done="${pr.done?1:0}" title="${pr.done?'Fullført':'Ikke fullført'}" aria-pressed="${pr.done?true:false}">✓</button>
                      </td>
                      <td><input class="field" type="text" value="${esc(pr.signed_by||'')}" placeholder="Skriv inn navn" style="width:100%"></td>
                      <td><input class="field" type="date" value="${pr.date||''}" style="min-width:140px"></td>
                    </tr>`;
                }).join('')).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }).join('') || '<div class="note">Ingen punkter i katalogen.</div>';

    $('#userBook').innerHTML = html;

    // lagre on-change
    $$('#userBook tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const b  = tr.querySelector('.mini-check');

      async function commit(action=null){
        let done = !!selUserProg.get(id)?.done;
        if(action==='toggle'){ done=!done; if(done && !d.value) d.value=today(); if(!done) d.value=''; }
        await upsertProgress(id,{ date:d.value||null, signed_by:(s.value||null), done }, selUserId);
        selUserProg.set(id,{ item_id:id, date:d.value||null, signed_by:s.value||null, done });

        b.setAttribute('data-done', done ? '1' : '0');
        b.setAttribute('aria-pressed', done ? 'true' : 'false');
        b.title = done ? 'Fullført' : 'Ikke fullført';
        b.classList.add('flash'); setTimeout(()=>b.classList.remove('flash'), 220);
      }
      s.onchange=()=>commit();
      d.onchange=()=>commit();
      b.onclick =()=>commit('toggle');
    });
  }

  /* ---------- Katalog-modal ---------- */
  function fillRoleSelect(){
    $('#catRole').innerHTML = ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');
  }
  function openCatalog(){ $('#catModal').classList.add('open'); drawCatalogEditor(); }
  function closeCatalog(){ $('#catModal').classList.remove('open'); }

  async function drawCatalogEditor(){
    const role=$('#catRole').value;
    const secs=catalog[role]||[];
    const wrap=$('#catWrap');

    if(!secs.length){
      wrap.innerHTML='<div class="note">Ingen inndelinger. Trykk “+ Inndeling”.</div>'; return;
    }

    wrap.innerHTML = secs.map((s,si)=>`
      <div class="box" style="margin-bottom:10px">
        <div class="hd">
          <div class="row" style="gap:8px;align-items:center">
            <span class="note">${si+1}</span>
            <input class="field secTitle" data-si="${si}" value="${esc(s.title)}" style="min-width:240px">
            <button class="btn small" data-act="secUp" data-si="${si}">↑</button>
            <button class="btn small" data-act="secDown" data-si="${si}">↓</button>
            <button class="btn small" data-act="secDel" data-si="${si}">Slett</button>
            <span class="note" style="margin-left:auto">Nytt punkt</span>
            <input class="field newItem" data-si="${si}" placeholder="Beskrivelse …" style="min-width:260px">
            <button class="btn small primary" data-act="addItem" data-si="${si}">+ Legg til</button>
          </div>
        </div>
        <div class="bd">
          <ul class="list">
            ${(s.items||[]).map((it,ii)=>`
              <li data-si="${si}" data-ii="${ii}">
                <span class="muted">${esc(it.text)}</span>
                <div class="row" style="gap:6px">
                  <button class="btn small" data-act="itUp">↑</button>
                  <button class="btn small" data-act="itDown">↓</button>
                  <button class="btn small" data-act="itEdit">Rediger</button>
                  <button class="btn small" data-act="itEx">Eksempel ${it.has_example? '✓':''}</button>
                  <button class="btn small" data-act="itDel">Slett</button>
                </div>
              </li>`).join('')}
          </ul>
        </div>
      </div>
    `).join('');

    // titteloppdatering
    $$('#catWrap .secTitle').forEach(inp=>{
      inp.onchange=async()=>{ const si=+inp.dataset.si; await updateSectionTitle(secs[si].id, inp.value.trim()||secs[si].title); catalog=await loadCatalog(); drawCatalogEditor(); };
    });

    // seksjonsknapper
    $$('#catWrap [data-act]').forEach(btn=>{
      btn.onclick=async()=>{
        const act=btn.dataset.act; const si=+btn.dataset.si;
        if(act==='secDel'){ if(!confirm('Slette inndeling?')) return; await deleteSection(secs[si].id); catalog=await loadCatalog(); drawCatalogEditor(); return; }
        if(act==='secUp'){  if(si>0){ await moveSection(secs[si].id, secs[si].position, secs[si-1].id, secs[si-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
        if(act==='secDown'){ if(si<secs.length-1){ await moveSection(secs[si].id, secs[si].position, secs[si+1].id, secs[si+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
        if(act==='addItem'){ const inp=$(`#catWrap .newItem[data-si="${si}"]`); const txt=(inp.value||'').trim(); if(!txt) return; await addItem(secs[si].id, txt); inp.value=''; catalog=await loadCatalog(); drawCatalogEditor(); return; }
      };
    });

    // item-aksjoner
    $$('#catWrap li [data-act]').forEach(btn=>{
      btn.onclick=async()=>{
        const li=btn.closest('li'); const si=+li.dataset.si; const ii=+li.dataset.ii; const s=catalog[$('#catRole').value][si]; const it=s.items[ii];
        if(btn.dataset.act==='itUp'){ if(ii>0){ await moveItem(it.id, it.position, s.items[ii-1].id, s.items[ii-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itDown'){ if(ii<s.items.length-1){ await moveItem(it.id, it.position, s.items[ii+1].id, s.items[ii+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itEdit'){ const nt=prompt('Rediger beskrivelse:', it.text); if(nt!=null){ await editItem(it.id, nt.trim()); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itDel'){ if(!confirm('Slette punkt?')) return; await deleteItem(it.id); catalog=await loadCatalog(); drawCatalogEditor(); }
        if(btn.dataset.act==='itEx'){ openExampleEditor(it); }
      };
    });

    $('#catRole').onchange = drawCatalogEditor;
    $('#addSec').onclick = async()=>{ await addSection($('#catRole').value); catalog=await loadCatalog(); drawCatalogEditor(); };
  }

  /* ---------- Eksempel-editor ---------- */
  function openExampleEditor(item){
    exItemId = item.id;
    $('#exToggle').checked = !!item.has_example;
    $('#exText').value = item.example_text || '';
    $('#exDot').classList.toggle('on', !!item.has_example);
    $('#exModal').classList.add('open');
  }
  async function saveExample(){
    const enabled = $('#exToggle').checked;
    const text = $('#exText').value;
    await setItemExample(exItemId, enabled, text);
    catalog = await loadCatalog();
    drawCatalogEditor();
    $('#exModal').classList.remove('open');
  }

  /* ---------- Kommentarer ---------- */
  async function drawComments(uid){
    const arr = await loadComments(uid);
    $('#commentList').innerHTML = arr.map(c=>`
      <li><span>${esc(c.text)}</span><span class="note">${new Date(c.created_at).toLocaleString('no-NO')}</span></li>
    `).join('') || '<li><span class="note">Ingen kommentarer.</span></li>';
  }

  /* ---------- Slett bruker ---------- */
  async function deleteUser(uid){
    const u = users.find(x=>x.id===uid);
    if(!confirm(`Slette bruker "${u?.name||u?.email||uid}"?`)) return;
    await sb.from('progress').delete().eq('user_id', uid);
    await sb.from('comments').delete().or(`user_id.eq.${uid},author_id.eq.${uid}`);
    await sb.from('logs').delete().eq('actor_id', uid);
    await sb.from('profiles').delete().eq('id', uid);
    users = users.filter(x=>x.id!==uid);
    selUserId=null; selUserProg=new Map();
    renderUsers();
    $('#userBook').innerHTML='<div class="note">Velg en bruker til venstre.</div>';
  }

  /* ---------- Logg-modal ---------- */
  async function openLog(){
    $('#logModal').classList.add('open');
    const entries = await loadLogs(150);
    $('#logList').innerHTML = entries.map(l=>`
      <div class="row" style="gap:8px;font-size:12px;padding:2px 0">
        <span class="note">${new Date(l.created_at).toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'})}</span>
        <span>${esc(l.message||'')}</span>
      </div>
    `).join('') || '<div class="note">Tom logg.</div>';
  }

  /* ---------- UI helpers ---------- */
  function bindTopButtons(){
    $('#btnOpenCatalog').onclick = openCatalog;
    $('#catClose').onclick = closeCatalog;
    $('#btnOpenLog').onclick = openLog;
    $('#logClose').onclick = ()=> $('#logModal').classList.remove('open');
    $('#exClose').onclick = ()=> $('#exModal').classList.remove('open');
    $('#exToggle').onchange = ()=> $('#exDot').classList.toggle('on', $('#exToggle').checked);
    $('#exSave').onclick = saveExample;
  }

  function toast(msg){
    let t=document.getElementById('toast');
    if(!t){ t=document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
    t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
  }

  init();
})();
</script>
</body>
</html>
