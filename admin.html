<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mannskapsbok – Admin</title>
  <link rel="stylesheet" href="./assets/styles.css?v=adminA3">
  <style>
    /* side-spesifikk liten polish */
    .user-list li{cursor:pointer;border-left:3px solid transparent}
    .user-list li.active{outline:3px solid rgba(37,99,235,.25); background:#f0f7ff; border-left-color:#2563eb}
    .user-actions{display:flex;gap:6px;flex-wrap:wrap}
  </style>
</head>
<body>

<!-- Header -->
<div class="rk-header">
  <div class="wrap rk-head-inner">
    <div class="rk-logo"></div>
    <div class="rk-title">Røde Kors<span class="rk-sub">Båten Bjørgvin</span></div>
  </div>
</div>
<nav class="rk-nav">
  <div class="wrap">
    <a href="./elev.html">Hovedmeny</a>
  </div>
</nav>

<div class="wrap" id="app">Laster …</div>

<!-- Katalog-modal -->
<div id="catModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="catTitle">
    <div class="modal-hd">
      <span id="catTitle">Katalog – rediger punkter og inndelinger</span>
      <button id="catClose" class="btn small">Lukk</button>
    </div>
    <div class="modal-bd">
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <label>Rolle:
          <select id="catRole" class="field" style="min-width:160px"></select>
        </label>
        <button id="addSec" class="btn small primary">+ Inndeling</button>
      </div>
      <div id="catWrap"></div>
    </div>
  </div>
</div>

<script type="module">
import {
  sb,
  ensureUserOrRedirect,
  loadCatalog, loadProgressFor, loadComments, loadLogs,
  upsertProgress, addComment,
  addSection, updateSectionTitle, moveSection, deleteSection,
  addItem, editItem, deleteItem, moveItem
} from "./assets/common.js?v=adminA3";

(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&gt;"}[m]));
  const today=()=>new Date().toISOString().slice(0,10);

  const ROLE_ORDER=['Fartøysjef','NK','Matros','Rescuerunner','Aspirant'];

  let me=null, catalog={}, users=[], selUserId=null, selUser=null, selUserProg=new Map(), rt=null;

  async function init(){
    try{
      me = await ensureUserOrRedirect();
      const { data:prof, error:perr } = await sb.from("profiles").select("is_admin").eq("id", me.id).single();
      if(perr) throw perr;
      if(!prof?.is_admin){
        $('#app').innerHTML = `<div class="box"><div class="hd">Ingen tilgang</div><div class="bd">Denne siden er bare for administratorer.</div></div>`;
        return;
      }

      [users, catalog] = await Promise.all([loadUsersWithAdminFlag(), loadCatalog()]);
      render(); bindRealtime();
    }catch(e){
      $('#app').innerHTML = `<div class="box"><div class="hd">Feil</div><div class="bd" style="color:#b00020">${esc(e.message||e)}</div></div>`;
      console.error(e);
    }
  }

  async function loadUsersWithAdminFlag(){
    const { data, error } = await sb.from("profiles").select("id,name,email,is_admin").order("email",{ascending:true});
    if(error) throw error;
    return data||[];
  }

  function render(){
    $('#app').innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>Admin</h1>

        <!-- logg -->
        <div class="row drop-wrap">
          <button id="btnLog" class="btn small">Logg</button>
          <div id="logDrop" class="drop-panel" role="region" aria-hidden="true">
            <div class="drop-hd">
              <span>Systemlogg</span>
              <div class="row" style="gap:6px">
                <button id="logRefresh" class="btn small">Oppdater</button>
                <button id="logClose" class="btn small">Lukk</button>
              </div>
            </div>
            <div id="logList" class="drop-bd">—</div>
          </div>
        </div>
      </div>

      <div class="split">
        <!-- VENSTRE -->
        <div>
          <div class="box">
            <div class="hd">Velg bruker</div>
            <div class="bd">
              <input id="userSearch" class="field" placeholder="Søk navn/e-post …" style="width:100%;margin-bottom:10px">
              <ul id="userList" class="list user-list"></ul>
            </div>
          </div>

          <div class="box">
            <div class="hd">Katalog</div>
            <div class="bd">
              <button id="openCatalog" class="btn primary">Åpne redigering</button>
            </div>
          </div>
        </div>

        <!-- HØYRE -->
        <div>
          <div class="box">
            <div class="hd" id="selHdr">Velg en bruker</div>
            <div class="bd" id="userArea"><div class="note">Ingen valgt.</div></div>
          </div>

          <div class="box">
            <div class="hd">Kommentarer</div>
            <div class="bd">
              <div class="row" style="gap:8px">
                <input id="commentTxt" class="field" placeholder="Skriv kommentar til elev" style="flex:1;min-width:240px">
                <button id="addComment" class="btn small">Legg til</button>
              </div>
              <ul id="commentList" class="list" style="margin-top:8px;max-height:220px"></ul>
            </div>
          </div>
        </div>
      </div>
    `;

    // logg
    $('#btnLog').onclick    = async (e)=>{ e.stopPropagation(); await toggleLog(true); };
    $('#logRefresh').onclick= async (e)=>{ e.stopPropagation(); await fillLogList(); };
    $('#logClose').onclick  = (e)=>{ e.stopPropagation(); toggleLog(false); };
    document.addEventListener('click',(ev)=>{
      const drop = $('#logDrop');
      if(drop.classList.contains('open') && !$('.drop-wrap').contains(ev.target)){ toggleLog(false); }
    });

    $('#userSearch').oninput = drawUsers;
    $('#openCatalog').onclick = openCatalogModal;
    $('#catClose').onclick = closeCatalogModal;

    const sel = $('#catRole'); sel.innerHTML = ROLE_ORDER.map(r=>`<option value="${r}">${r}</option>`).join('');

    drawUsers();
  }

  async function fillLogList(){
    const entries = await loadLogs(200);
    $('#logList').innerHTML = entries.map(l=>`
      <div class="log-row">
        <span class="note">${new Date(l.created_at).toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'})}</span>
        <span class="msg">${esc(l.message||'')}</span>
      </div>
    `).join('') || '<div class="note">Tom logg.</div>';
  }
  async function toggleLog(open){
    const drop = $('#logDrop');
    const willOpen = (open===true) ? true : (open===false ? false : !drop.classList.contains('open'));
    if(willOpen){ await fillLogList(); }
    drop.classList.toggle('open', willOpen);
  }

  /* --- Brukerliste --- */
  function drawUsers(){
    const list = $('#userList');
    const q = ($('#userSearch').value||'').toLowerCase();
    const arr = users.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
    if(!arr.length){ list.innerHTML='<li><span class="note">Ingen brukere</span></li>'; return; }

    list.innerHTML = arr.map(u=>`
      <li data-id="${u.id}" class="${u.id===selUserId?'active':''}">
        <div>
          <div><b>${esc(u.name||u.email||u.id)}</b> ${u.is_admin ? '<span class="badge admin">Admin</span>' : ''}</div>
          <div class="note">${esc(u.email||'')}</div>
        </div>
        <span class="pill">${u.id===selUserId?'Åpen':'Klikk for å åpne'}</span>
      </li>
    `).join('');

    $$('#userList li').forEach(li => li.onclick = ()=> selectUser(li.getAttribute('data-id')));
  }

  async function selectUser(uid){
    selUserId = uid;
    selUser = users.find(x=>x.id===uid)||null;
    if(!selUser){ $('#userArea').innerHTML='<div class="note">Fant ikke bruker.</div>'; return; }

    selUserProg = await loadProgressFor(uid);
    $('#selHdr').innerHTML = `Mannskapsbok: <b>${esc(selUser.name||selUser.email||selUser.id)}</b>`;
    renderUserArea();
    await drawComments(uid);
    drawUsers();
  }

  async function drawComments(uid){
    const { data, error } = await sb.from("comments").select("id,text,created_at").eq("user_id",uid).order("created_at",{ascending:false});
    const arr = error?[]:(data||[]);
    $('#commentList').innerHTML = arr.map(c=>`
      <li><span>${esc(c.text)}</span><span class="note">${new Date(c.created_at).toLocaleString('no-NO')}</span></li>
    `).join('') || '<li><span class="note">Ingen kommentarer.</span></li>';

    $('#addComment').onclick = async ()=>{
      const t=($('#commentTxt').value||'').trim(); if(!t) return;
      await addComment(uid, t, me.id); $('#commentTxt').value=''; await drawComments(uid);
    };
  }

  function renderUserArea(){
    const el = $('#userArea');

    const headerControls = `
      <div class="user-actions" style="margin-bottom:10px">
        <input id="uName" class="field" placeholder="Navn"  value="${esc(selUser.name||'')}"  style="min-width:220px">
        <input id="uMail" class="field" placeholder="E-post" value="${esc(selUser.email||'')}" style="min-width:240px">
        <button id="btnSaveProfile" class="btn">Lagre profil</button>
        ${selUser.is_admin
          ? '<button id="btnUnsetAdmin" class="btn">Fjern admin</button>'
          : '<button id="btnSetAdmin" class="btn">Gjør til admin</button>'}
        <button id="btnDeleteUser" class="btn">Slett bruker</button>
      </div>
    `;

    const accHtml = ROLE_ORDER.map(role=>{
      const secs = catalog[role]||[];
      const countAll = secs.reduce((n,s)=> n + (s.items?.length||0), 0);
      let done=0; secs.forEach(s=> (s.items||[]).forEach(it=>{ if(selUserProg.get(String(it.id))?.done) done++; }));
      const stateCls = (countAll>0 && done===countAll) ? ' state-green' : (done>0 ? ' state-yellow' : '');
      return `
        <div class="accordion${stateCls}" data-role="${role}">
          <div class="acc-hd">
            <span>${role}</span>
            <span class="acc-count">${done}/${countAll} fullført</span>
          </div>
          <div class="acc-bd">
            ${secs.length? secs.map((s,si)=>`
              <div class="box" style="margin-bottom:12px">
                <div class="hd">${esc(s.title)}</div>
                <div class="bd">
                  <div class="table-wrap">
                    <table>
                      <thead><tr><th style="width:56px">#</th><th>Beskrivelse</th><th style="width:260px">Sjekket ut av</th><th style="width:170px">Dato</th><th style="width:90px">Avkryss</th></tr></thead>
                      <tbody>
                        ${(s.items||[]).map((it,ii)=>{
                          const key=String(it.id), pr=selUserProg.get(key)||{};
                          const exBtn = it.has_example ? `<button class="btn small" data-ex="1">Eksempel</button>` : '';
                          return `<tr data-id="${key}">
                            <td>${si+1}.${ii+1}</td>
                            <td>${esc(it.text)} ${it.has_example?'<span class="badge ex-flag mini">har eksempel</span>':''}</td>
                            <td class="signcell">
                              <input class="field" type="text" value="${esc(pr.signed_by||'')}" placeholder="Skriv inn navn">
                              ${exBtn}
                            </td>
                            <td><input class="field" type="date" value="${pr.date||''}"></td>
                            <td style="text-align:center"><button class="mini-check" data-done="${pr.done?1:0}" aria-pressed="${pr.done?true:false}">✓</button></td>
                          </tr>`;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            `).join('') : '<div class="note">Ingen punkter.</div>'}
          </div>
        </div>
      `;
    }).join('');

    el.innerHTML = headerControls + accHtml;

    // profilknapper
    $('#btnSaveProfile').onclick = async ()=>{
      const name=$('#uName').value.trim(), email=$('#uMail').value.trim();
      await sb.from('profiles').update({ name, email }).eq('id', selUserId);
      users = await loadUsersWithAdminFlag();
      selUser = users.find(x=>x.id===selUserId);
      $('#selHdr').innerHTML = `Mannskapsbok: <b>${esc(selUser.name||selUser.email||selUser.id)}</b>`;
      drawUsers();
    };
    const setAdmin = async (v)=>{ await sb.from('profiles').update({ is_admin: v }).eq('id', selUserId); users=await loadUsersWithAdminFlag(); selUser=users.find(x=>x.id===selUserId); renderUserArea(); drawUsers(); };
    const delUser = async ()=>{
      if(!confirm(`Slette bruker "${selUser?.name||selUser?.email||selUserId}"? Dette sletter progresjon, kommentarer, logger og profil.`)) return;
      await sb.from('progress').delete().eq('user_id', selUserId);
      await sb.from('comments').delete().or(`user_id.eq.${selUserId},author_id.eq.${selUserId}`);
      await sb.from('logs').delete().eq('actor_id', selUserId);
      await sb.from('profiles').delete().eq('id', selUserId);
      users = users.filter(x=>x.id!==selUserId);
      selUserId=null; selUser=null; selUserProg=new Map();
      render();
    };
    $('#btnDeleteUser').onclick = delUser;
    const bSet=$('#btnSetAdmin'), bUnset=$('#btnUnsetAdmin');
    if(bSet) bSet.onclick=()=>setAdmin(true);
    if(bUnset) bUnset.onclick=()=>setAdmin(false);

    // accordion toggle
    $$('.acc-hd', el).forEach(h=> h.onclick = ()=> h.parentElement.classList.toggle('open'));

    // progress-handlers
    $$('#userArea tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const b  = tr.querySelector('.mini-check');
      const ex = tr.querySelector('[data-ex]');

      async function commit(action=null){
        let done = !!selUserProg.get(id)?.done;
        if(action==='toggle'){ done=!done; if(done && !d.value) d.value=today(); if(!done) d.value=''; }
        await upsertProgress(id,{ date:d.value||null, signed_by:(s.value||null), done }, selUserId);
        selUserProg.set(id,{ item_id:id, date:d.value||null, signed_by:s.value||null, done });
        b.setAttribute('data-done', done ? '1':'0');
        b.setAttribute('aria-pressed', done ? 'true':'false');
        renderUserArea(); // enkel refresh for å oppdatere summer/farger
      }
      s.onchange=()=>commit();
      d.onchange=()=>commit();
      b.onclick =()=>commit('toggle');

      if(ex){
        ex.onclick = ()=>{
          let exText = '';
          for(const sec of (catalog[tr.closest('.accordion')?.getAttribute('data-role')]||[])){
            const it = (sec.items||[]).find(i=> String(i.id)===id);
            if(it){ exText = it.example_text||''; break; }
          }
          alert(exText || 'Ingen eksempeltekst.');
        };
      }
    });
  }

  /* ---------- Katalog-modal ---------- */
  function openCatalogModal(){
    $('#catModal').classList.add('open');
    $('#catRole').value = ROLE_ORDER[0];
    drawCatalogEditor();
  }
  function closeCatalogModal(){ $('#catModal').classList.remove('open'); }

  $('#addSec')?.addEventListener('click', async()=>{
    await addSection($('#catRole').value);
    catalog = await loadCatalog();
    drawCatalogEditor();
  });
  $('#catRole')?.addEventListener('change', drawCatalogEditor);

  async function drawCatalogEditor(){
    const role=$('#catRole').value; const secs=catalog[role]||[]; const wrap=$('#catWrap');
    if(!secs.length){ wrap.innerHTML='<div class="note">Ingen inndelinger. Trykk “+ Inndeling”.</div>'; return; }

    wrap.innerHTML = secs.map((s,si)=>`
      <div class="box" style="margin-bottom:10px">
        <div class="hd">
          <div class="row" style="gap:8px;align-items:center">
            <span class="note">${si+1}</span>
            <input class="field secTitle" data-si="${si}" value="${esc(s.title)}" style="min-width:220px">
            <button class="btn small" data-act="secUp" data-si="${si}">↑</button>
            <button class="btn small" data-act="secDown" data-si="${si}">↓</button>
            <button class="btn small" data-act="secDel" data-si="${si}">Slett</button>
            <span class="note" style="margin-left:auto">Nytt punkt</span>
            <input class="field newItem" data-si="${si}" placeholder="Beskrivelse …" style="min-width:260px">
            <button class="btn small primary" data-act="addItem" data-si="${si}">+ Legg til</button>
          </div>
        </div>
        <div class="bd">
          <ul class="list">
            ${(s.items||[]).map((it,ii)=>`
              <li data-si="${si}" data-ii="${ii}">
                <span class="muted">${esc(it.text)}</span>
                <div class="row" style="gap:6px">
                  <button class="btn small" data-act="exToggle">${it.has_example?'Skru av eksempel':'Skru på eksempel'}</button>
                  <button class="btn small" data-act="exEdit">Rediger eksempel</button>
                  <button class="btn small" data-act="itUp">↑</button>
                  <button class="btn small" data-act="itDown">↓</button>
                  <button class="btn small" data-act="itEdit">Rediger</button>
                  <button class="btn small" data-act="itDel">Slett</button>
                </div>
              </li>`).join('')}
          </ul>
        </div>
      </div>
    `).join('');

    $$('#catWrap .secTitle').forEach(inp=>{
      inp.onchange=async()=>{ const si=+inp.dataset.si; await updateSectionTitle(secs[si].id, inp.value.trim()||secs[si].title); catalog=await loadCatalog(); drawCatalogEditor(); };
    });
    $$('#catWrap [data-act]').forEach(btn=>{
      btn.onclick=async()=>{
        const act=btn.dataset.act; const li=btn.closest('li'); const si=li?+li.dataset.si:+btn.dataset.si;
        if(!isNaN(si) && !li){
          if(act==='secDel'){ if(!confirm('Slette inndeling?')) return; await deleteSection(secs[si].id); catalog=await loadCatalog(); drawCatalogEditor(); return; }
          if(act==='secUp'){ if(si>0){ await moveSection(secs[si].id, secs[si].position, secs[si-1].id, secs[si-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
          if(act==='secDown'){ if(si<secs.length-1){ await moveSection(secs[si].id, secs[si].position, secs[si+1].id, secs[si+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
          if(act==='addItem'){ const inp=$(`#catWrap .newItem[data-si="${si}"]`); const txt=(inp.value||'').trim(); if(!txt) return; await addItem(secs[si].id, txt); inp.value=''; catalog=await loadCatalog(); drawCatalogEditor(); return; }
        }
        if(li){
          const ii = +li.dataset.ii; const s=catalog[role][si]; const it=s.items[ii];
          if(act==='itUp'){ if(ii>0){ await moveItem(it.id, it.position, s.items[ii-1].id, s.items[ii-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
          if(act==='itDown'){ if(ii<s.items.length-1){ await moveItem(it.id, it.position, s.items[ii+1].id, s.items[ii+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
          if(act==='itEdit'){ const nt=prompt('Rediger beskrivelse:', it.text); if(nt!=null){ await editItem(it.id, nt.trim()); catalog=await loadCatalog(); drawCatalogEditor(); } }
          if(act==='itDel'){ if(!confirm('Slette punkt?')) return; await deleteItem(it.id); catalog=await loadCatalog(); drawCatalogEditor(); }
          if(act==='exToggle'){ await sb.from('items').update({ has_example: !it.has_example }).eq('id', it.id); catalog=await loadCatalog(); drawCatalogEditor(); }
          if(act==='exEdit'){ const nx=prompt('Eksempel / forklaring:', it.example_text||''); if(nx!==null){ await sb.from('items').update({ example_text:nx }).eq('id', it.id); catalog=await loadCatalog(); drawCatalogEditor(); } }
        }
      };
    });
  }

  /* ---------- Realtime ---------- */
  function bindRealtime(){
    if(rt){ sb.removeChannel(rt); rt=null; }
    rt = sb.channel('mb-live-admin')
      .on('postgres_changes',{event:'*',schema:'public',table:'sections'}, async()=>{ catalog=await loadCatalog(); if(selUserId){ selUserProg = await loadProgressFor(selUserId); renderUserArea(); } })
      .on('postgres_changes',{event:'*',schema:'public',table:'items'},    async()=>{ catalog=await loadCatalog(); if(selUserId){ selUserProg = await loadProgressFor(selUserId); renderUserArea(); } })
      .on('postgres_changes',{event:'*',schema:'public',table:'progress'}, async(payload)=>{
        const row = payload.new || payload.old;
        if(selUserId && row?.user_id===selUserId){ selUserProg = await loadProgressFor(selUserId); renderUserArea(); }
      })
      .subscribe();
  }

  init();
})();
</script>
</body>
</html>
