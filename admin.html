<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mannskapsbok – Admin</title>
  <link rel="stylesheet" href="./assets/styles.css?v=otp10">
  <style>
    /* liten modal for katalog */
    .backdrop{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(2,6,23,.35);backdrop-filter:saturate(120%) blur(2px);padding:24px;z-index:1000}
    .backdrop.open{display:flex}
    .card{width:min(900px,96vw);max-height:88vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .card .hd{padding:14px 16px;background:#f8fafc;border-bottom:1px solid var(--line);font-weight:800}
    .card .bd{padding:14px 16px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.on{background:#ecfdf5;border-color:#34d399;color:#065f46}
  </style>
</head>
<body>

<!-- Header -->
<div class="rk-header">
  <div class="wrap rk-head-inner">
    <div class="rk-logo"></div>
    <div class="rk-title">Røde Kors<span class="rk-sub">Båten Bjørgvin</span></div>
  </div>
</div>
<nav class="rk-nav"><div class="wrap"><a href="./elev.html">Hovedmeny</a></div></nav>

<div class="wrap" id="app">Laster …</div>

<!-- Katalog-modal -->
<div id="catModal" class="backdrop" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-labelledby="catHdr">
    <div class="hd">
      <span id="catHdr">Katalog – rediger punkter og inndelinger</span>
      <button id="catClose" class="btn small" style="float:right">Lukk</button>
    </div>
    <div class="bd">
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <label>Rolle:
          <select id="catRole" class="field" style="min-width:160px"></select>
        </label>
        <button id="addSec" class="btn small primary">+ Inndeling</button>
      </div>
      <div id="catWrap"></div>
    </div>
  </div>
</div>

<script type="module">
import {
  sb, ROLES,
  ensureUserOrRedirect, listUsers, loadCatalog, loadProgressFor, loadComments, loadLogs,
  upsertProgress, addComment,
  addSection, updateSectionTitle, moveSection, deleteSection,
  addItem, editItem, deleteItem, moveItem, setItemExample,
  setUserAdmin
} from "./assets/common.js?v=otp10";

(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
  const today=()=>new Date().toISOString().slice(0,10);

  let me=null, users=[], catalog={}, selUserId=null, selUserProg=new Map(), rt=null;

  async function init(){
    try{
      me = await ensureUserOrRedirect();

      [users, catalog] = await Promise.all([listUsers(), loadCatalog()]);
      render(); bindRealtime();
    }catch(e){
      $('#app').innerHTML = `<div class="box"><div class="hd">Feil</div><div class="bd" style="color:#b00020">${esc(e.message||e)}</div></div>`;
      console.error(e);
    }
  }

  function render(){
    $('#app').innerHTML = `
      <div class="row" style="justify-content:space-between">
        <h1>Admin</h1>
        <div class="row" style="gap:8px">
          <button id="btnCatalog" class="btn">Katalog</button>
          <a class="btn" href="./elev.html">← Til elev-siden</a>
        </div>
      </div>

      <div class="split">
        <div>
          <div class="box">
            <div class="hd">Brukere</div>
            <div class="bd">
              <input id="userSearch" class="field" placeholder="Søk navn/epost …" style="width:100%;margin-bottom:10px">
              <ul id="userList" class="list"></ul>
            </div>
          </div>
        </div>

        <div>
          <div class="box">
            <div class="hd">
              <span id="selHdr">Velg en bruker</span>
              <div class="row" style="gap:8px;margin-left:auto">
                <button id="toggleAdmin" class="btn small" disabled>Gjør admin</button>
                <button id="btnDeleteUser" class="btn small" disabled>Slett bruker</button>
              </div>
            </div>
            <div class="bd" id="userBook"><div class="note">Ingen valgt.</div></div>
          </div>

          <div class="box" style="margin-top:12px">
            <div class="hd">Kommentarer</div>
            <div class="bd">
              <div class="row" style="gap:8px">
                <input id="commentTxt" class="field" placeholder="Skriv kommentar til elev" style="flex:1;min-width:240px">
                <button id="addComment" class="btn small">Legg til</button>
              </div>
              <ul id="commentList" class="list" style="margin-top:8px;max-height:220px"></ul>
            </div>
          </div>
        </div>
      </div>
    `;

    // fyll rolle-valg i modal
    $('#catRole').innerHTML = ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');

    $('#btnCatalog').onclick = ()=> toggleCatalog(true);
    $('#catClose').onclick   = ()=> toggleCatalog(false);

    $('#userSearch').oninput = drawUsers;

    $('#addSec').onclick     = async()=>{
      await addSection($('#catRole').value);
      catalog = await loadCatalog();
      drawCatalogEditor();
    };

    drawUsers();
    drawCatalogEditor();
  }

  async function drawUsers(){
    const list = $('#userList');
    const q = ($('#userSearch').value||'').toLowerCase();
    const arr = users.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
    if(!arr.length){ list.innerHTML='<li><span class="note">Ingen brukere</span></li>'; return; }

    list.innerHTML = arr.map(u=>`
      <li data-id="${u.id}" style="cursor:pointer">
        <div>
          <div><b>${esc(u.name||u.email||u.id)}</b> ${u.is_admin?'<span class="badge admin">Admin</span>':''}</div>
          <div class="note">${esc(u.email||'')}</div>
        </div>
        <span class="badge" id="sum-${u.id}">…</span>
      </li>
    `).join('');

    $$('#userList li').forEach(li => li.onclick = ()=> selectUser(li.getAttribute('data-id')));

    for(const u of arr){
      const map = await loadProgressFor(u.id);
      const total = Object.values(catalog).flatMap(secs=>secs.flatMap(s=>s.items)).length;
      let done=0; for(const v of map.values()) if(v?.done) done++;
      const chip = $(`#sum-${u.id}`); if(chip) chip.textContent = `${done}/${total}`;
    }
  }

  async function selectUser(uid){
    selUserId = uid;
    const u = users.find(x=>x.id===uid);
    if(!u){ $('#userBook').innerHTML='<div class="note">Fant ikke bruker.</div>'; return; }

    selUserProg = await loadProgressFor(uid);
    $('#selHdr').innerHTML = `${esc(u.name||u.email||u.id)} ${u.is_admin?'<span class="badge admin">Admin</span>':''}`;
    $('#btnDeleteUser').disabled = false;
    $('#toggleAdmin').disabled   = false;
    $('#toggleAdmin').textContent = u.is_admin ? 'Fjern admin' : 'Gjør admin';

    await renderUserBook(uid, true);
    await drawComments(uid);

    $('#addComment').onclick = async ()=>{
      const t=($('#commentTxt').value||'').trim(); if(!t) return;
      await addComment(uid, t, me.id); $('#commentTxt').value=''; await drawComments(uid);
    };
    $('#btnDeleteUser').onclick = ()=> deleteUser(uid);
    $('#toggleAdmin').onclick   = async ()=>{
      const newVal = !u.is_admin;
      await setUserAdmin(uid, newVal);
      users = await listUsers();
      const nu = users.find(x=>x.id===uid);
      $('#toggleAdmin').textContent = nu.is_admin ? 'Fjern admin' : 'Gjør admin';
      $('#selHdr').innerHTML = `${esc(nu.name||nu.email||nu.id)} ${nu.is_admin?'<span class="badge admin">Admin</span>':''}`;
      drawUsers();
    };
  }

  async function renderUserBook(uid, editable){
    const el = $('#userBook');
    const html = ROLES.map(role=>{
      const secs=catalog[role]||[];
      if(!secs.length) return '';
      return `
        <div class="box" style="margin-bottom:12px">
          <div class="hd">${role}</div>
          <div class="bd table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:60px">#</th>
                  <th>Beskrivelse</th>
                  <th style="width:240px">Sjekket ut av</th>
                  <th class="w-date">Dato</th>
                  <th class="w-check">Avkryss</th>
                </tr>
              </thead>
              <tbody>
                ${secs.map((s,si)=> s.items.map((it,ii)=>{
                  const key = String(it.id);
                  const pr  = selUserProg.get(key)||{};
                  const dis = editable?'':'disabled';
                  return `
                    <tr data-id="${key}">
                      <td>${si+1}.${ii+1}</td>
                      <td>${esc(it.text)}</td>
                      <td><input ${dis} class="field" type="text" value="${esc(pr.signed_by||'')}" placeholder="Skriv inn navn" style="width:100%"></td>
                      <td class="datecell w-date"><input ${dis} class="field" type="date" value="${pr.date||''}"></td>
                      <td class="checkcell w-check"><button ${dis} class="mini-check" data-done="${pr.done?1:0}" title="Avkryss">✓</button></td>
                    </tr>`;
                }).join('')).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }).join('') || '<div class="note">Ingen punkter i katalogen.</div>';

    el.innerHTML = html;

    $$('#userBook tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const b  = tr.querySelector('.mini-check');

      async function commit(action=null){
        let done = !!selUserProg.get(id)?.done;
        if(action==='toggle'){ done=!done; if(done && !d.value) d.value=today(); if(!done) d.value=''; }
        await upsertProgress(id,{ date:d.value||null, signed_by:(s.value||null), done }, uid);
        selUserProg.set(id,{ item_id:id, date:d.value||null, signed_by:s.value||null, done });
        b.setAttribute('data-done', done ? '1':'0');
      }
      s.onchange=()=>commit();
      d.onchange=()=>commit();
      b.onclick =()=>commit('toggle');
    });
  }

  async function drawComments(uid){
    const arr = await loadComments(uid);
    $('#commentList').innerHTML = arr.map(c=>`
      <li><span>${esc(c.text)}</span><span class="note">${new Date(c.created_at).toLocaleString('no-NO')}</span></li>
    `).join('') || '<li><span class="note">Ingen kommentarer.</span></li>';
  }

  async function deleteUser(uid){
    const u = users.find(x=>x.id===uid);
    if(!confirm(`Slette bruker "${u?.name||u?.email||uid}"? Dette sletter progresjon, kommentarer, logger og profil.`)) return;
    await sb.from('progress').delete().eq('user_id', uid);
    await sb.from('comments').delete().or(`user_id.eq.${uid},author_id.eq.${uid}`);
    await sb.from('logs').delete().eq('actor_id', uid);
    await sb.from('profiles').delete().eq('id', uid);
    users = users.filter(x=>x.id!==uid);
    selUserId=null; selUserProg=new Map();
    render();
  }

  /* ----- Katalog-editor i modal ----- */
  function toggleCatalog(open){
    const bd = $('#catModal');
    bd.classList.toggle('open', !!open);
    bd.style.display = open ? 'flex' : 'none';
    if(open) drawCatalogEditor();
  }

  async function drawCatalogEditor(){
    $('#catRole').innerHTML = ROLES.map(r=>`<option value="${r}" ${r===$('#catRole').value?'selected':''}>${r}</option>`).join('') || ROLES.map(r=>`<option value="${r}">${r}</option>`).join('');
    const role=$('#catRole').value || ROLES[0];
    const secs=catalog[role]||[];
    const wrap=$('#catWrap');

    if(!secs.length){ wrap.innerHTML='<div class="note">Ingen inndelinger. Trykk “+ Inndeling”.</div>'; return; }

    wrap.innerHTML = secs.map((s,si)=>`
      <div class="box" style="margin-bottom:10px">
        <div class="hd">
          <div class="row" style="gap:8px;align-items:center">
            <span class="note">${si+1}</span>
            <input class="field secTitle" data-si="${si}" value="${esc(s.title)}" style="min-width:220px">
            <button class="btn small" data-act="secUp" data-si="${si}">↑</button>
            <button class="btn small" data-act="secDown" data-si="${si}">↓</button>
            <button class="btn small" data-act="secDel" data-si="${si}">Slett</button>
            <span class="note" style="margin-left:auto">Nytt punkt</span>
            <input class="field newItem" data-si="${si}" placeholder="Beskrivelse …" style="min-width:260px">
            <button class="btn small primary" data-act="addItem" data-si="${si}">+ Legg til</button>
          </div>
        </div>
        <div class="bd">
          <ul class="list">
            ${(s.items||[]).map((it,ii)=>`
              <li data-si="${si}" data-ii="${ii}">
                <span class="muted">${esc(it.text)}</span>
                <div class="row" style="gap:6px">
                  <button class="btn small" data-act="itUp">↑</button>
                  <button class="btn small" data-act="itDown">↓</button>
                  <button class="btn small" data-act="itEdit">Rediger</button>
                  <button class="btn small" data-act="itDel">Slett</button>
                  <!-- Eksempel-knapp -->
                  <button class="btn small ${it.has_example?'pill on':'pill'}" data-act="itEx">${it.has_example?'Eksempel på':'Legg til eksempel'}</button>
                </div>
              </li>`).join('')}
          </ul>
        </div>
      </div>
    `).join('');

    // hendelser
    $$('#catWrap .secTitle').forEach(inp=>{
      inp.onchange=async()=>{ const si=+inp.dataset.si; await updateSectionTitle(secs[si].id, inp.value.trim()||secs[si].title); catalog=await loadCatalog(); drawCatalogEditor(); };
    });
    $$('#catWrap [data-act]').forEach(btn=>{
      btn.onclick=async()=>{
        const act=btn.dataset.act; const si=+btn.dataset.si;
        if(act==='secDel'){ if(!confirm('Slette inndeling?')) return; await deleteSection(secs[si].id); catalog=await loadCatalog(); drawCatalogEditor(); return; }
        if(act==='secUp')  { if(si>0){ await moveSection(secs[si].id, secs[si].position, secs[si-1].id, secs[si-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
        if(act==='secDown'){ if(si<secs.length-1){ await moveSection(secs[si].id, secs[si].position, secs[si+1].id, secs[si+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } return; }
        if(act==='addItem'){ const inp=$(`#catWrap .newItem[data-si="${si}"]`); const txt=(inp.value||'').trim(); if(!txt) return; await addItem(secs[si].id, txt); inp.value=''; catalog=await loadCatalog(); drawCatalogEditor(); return; }
      };
    });

    $$('#catWrap li [data-act]').forEach(btn=>{
      btn.onclick=async()=>{
        const li=btn.closest('li'); const si=+li.dataset.si; const ii=+li.dataset.ii; const s=catalog[$('#catRole').value][si]; const it=s.items[ii];
        if(btn.dataset.act==='itUp'){ if(ii>0){ await moveItem(it.id, it.position, s.items[ii-1].id, s.items[ii-1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itDown'){ if(ii<s.items.length-1){ await moveItem(it.id, it.position, s.items[ii+1].id, s.items[ii+1].position); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itEdit'){ const nt=prompt('Rediger beskrivelse:', it.text); if(nt!=null){ await editItem(it.id, nt.trim()); catalog=await loadCatalog(); drawCatalogEditor(); } }
        if(btn.dataset.act==='itDel'){ if(!confirm('Slette punkt?')) return; await deleteItem(it.id); catalog=await loadCatalog(); drawCatalogEditor(); }
        if(btn.dataset.act==='itEx'){
          // toggle + rediger tekst
          let has = !!it.has_example;
          if(!has){
            const txt = prompt('Skriv eksempeltekst for punktet:','');
            if(txt!=null){ await setItemExample(it.id, true, txt); }
          }else{
            const choice = confirm('Fjerne eksempel? (OK=fjern, Avbryt=rediger)');
            if(choice){ await setItemExample(it.id, false, null); }
            else{
              const nt = prompt('Rediger eksempeltekst:', it.example_text||'');
              if(nt!=null){ await setItemExample(it.id, true, nt); }
            }
          }
          catalog = await loadCatalog(); drawCatalogEditor();
        }
      };
    });

    $('#catRole').onchange = drawCatalogEditor;
  }

  function bindRealtime(){
    if(rt){ sb.removeChannel(rt); rt=null; }
    rt = sb.channel('mb-live-admin')
      .on('postgres_changes',{event:'*',schema:'public',table:'sections'}, async()=>{ catalog=await loadCatalog(); if(selUserId) renderUserBook(selUserId, true); })
      .on('postgres_changes',{event:'*',schema:'public',table:'items'},    async()=>{ catalog=await loadCatalog(); if(selUserId) renderUserBook(selUserId, true); })
      .on('postgres_changes',{event:'*',schema:'public',table:'progress'}, async(payload)=>{ const row = payload.new || payload.old; if(selUserId && row?.user_id===selUserId){ selUserProg = await loadProgressFor(selUserId); renderUserBook(selUserId, true); } })
      .subscribe();
  }

  init();
})();
</script>
</body>
</html>
