<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mannskapsbok (demo)</title>
  <style>
    :root{--accent:#2b4dcb}
    *{box-sizing:border-box}
    body{margin:0;background:#fafafa;font:14px/1.4 Arial, sans-serif;color:#111}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .title{font-size:28px;font-weight:800;color:var(--accent);margin:0 0 6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:12px}
    .note{font-size:12px;color:#666}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:16px 0 8px}
    .card{border:1px solid #eee;border-radius:14px;background:#f7f7f7}
    .card button{width:100%;padding:16px 14px;border:0;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.08)}
    .card .sub{display:block;font-weight:400;font-size:12px;opacity:.85;margin-top:2px}
    .gray{background:#e5e5e5}.yellow{background:#ffe08a}.green{background:#9be29b}
    .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .tag{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f1f1;margin:0 0 6px}
    .table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .table th,.table td{border-bottom:1px solid #eee;padding:10px 8px;text-align:left;vertical-align:top}
    .table th{background:#fafafa;font-weight:700}
    .table tr:last-child td{border-bottom:0}
    .table input[type="text"],.table input[type="date"]{width:100%;padding:6px 8px;border:1px solid #ddd;border-radius:8px}
    .empty{padding:16px;color:#666}
    /* save bar */
    #savebar{position:fixed;left:12px;right:12px;bottom:12px;display:none;align-items:center;gap:10px;padding:10px 12px;border:1px solid #ddd;border-radius:12px;background:#fff;box-shadow:0 10px 28px rgba(0,0,0,.15);z-index:1000}
    #savebar .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f1f1}
    #savebar .btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#111;color:#fff;cursor:pointer}
    #toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s}
    #toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Mannskapsbok</div>
    <div class="row">
      <span class="badge">Demo – ingen innlogging</span>
      <span class="note">Alt lagres lokalt i nettleseren (kan trygt byttes ut med Supabase senere).</span>
    </div>

    <div id="cards" class="grid"></div>
    <div id="tabs" class="tabs"></div>
    <div id="panel"></div>
  </div>

  <div id="savebar">
    <span id="savecount" class="pill">0 endringer</span>
    <span id="savemsg" class="note">Endringer ikke lagret.</span>
    <div style="flex:1"></div>
    <button id="savebtn" class="btn">Lagre nå</button>
  </div>
  <div id="toast">Lagret ✅</div>

<script>
(function(){
  // ---- Demo-katalog ----
  const ROLES = ['Fartøysjef','NK','Matros','Aspirant','Rescuerunner'];

  const DEMO = {
    'Fartøysjef': [
      { title:'Sikkerhet & ledelse', items:[
        'Utføre sikkerhetsbrief for mannskap',
        'Planlegge operasjon med risikovurdering',
        'Loggføre hendelser etter aksjon',
        'Dele ut oppgaver og følge opp'
      ]},
      { title:'Navigasjon', items:[
        'Planlegge rute basert på vær og strøm',
        'Bruke radar/GPS korrekt',
        'Kommunikasjon på VHF (kanaler/protokoll)',
        'Nattnavigasjon – utkikk og lysbruk'
      ]},
      { title:'Maskin & vedlikehold', items:[
        'Start-/stopp-prosedyre motor',
        'Daglig kontroll av olje/kjøl',
        'Feilsøk ved alarm',
        'Fylle drivstoff sikkert'
      ]},
    ],
    'NK': [
      { title:'Operativ støtte', items:[
        'Koordinere mannskap under aksjon',
        'Føre enkel logg',
        'Sikre bruk av verneutstyr',
        'Forberede til kai/ankring'
      ]},
      { title:'Navigasjon', items:[
        'Avlese og melde posisjon',
        'Plotte kursendringer',
        'Oppfatte hinder/fare',
        'Håndtere møtende trafikk'
      ]},
      { title:'Fartøyhåndtering', items:[
        'Fortøyning – spring og kryss',
        'Bakke og manøvrere i trange farvann',
        'RIB-utsetting/innhenting',
        'Man-over-bord rutiner'
      ]},
    ],
    'Matros': [
      { title:'Dekksarbeid', items:[
        'Korrekt bruk av knuter/spleis',
        'Fendere og tau – plassering og sikring',
        'Sikring av last/utstyr',
        'Spyling og vask av dekk'
      ]},
      { title:'Sikkerhet', items:[
        'Redningsvest korrekt tilpasset',
        'Brannslukking – slokkemidler',
        'Nødutstyr: nødraketter/pyro',
        'MOB-øvelse deltatt'
      ]},
      { title:'Maskinrom', items:[
        'Sjekk av nivåer før avgang',
        'Filterkontroll',
        'Steng av hovedstrøm',
        'Orden i maskinrom'
      ]},
    ],
    'Aspirant': [
      { title:'Grunnleggende', items:[
        'Kjenne til roller om bord',
        'Sikkerhetsrunde på fartøyet',
        'Påkledning og verneutstyr',
        'Enkel knutebok'
      ]},
      { title:'Kommunikasjon', items:[
        'Lytte på VHF',
        'Alfabet/NUM-koder',
        'Enkle meldinger',
        'Rapportere observasjoner'
      ]},
      { title:'Fartøysrutiner', items:[
        'Rydde og sikre utstyr',
        'Assistere ved fortøyning',
        'Delta i øvelser',
        'Orden etter aksjon'
      ]},
    ],
    'Rescuerunner': [
      { title:'Kjøring', items:[
        'Oppstart og sjekkliste',
        'Planing og svingteknikk',
        'Sikker fart i sjø',
        'Nødstopp og retur'
      ]},
      { title:'Søk & redning', items:[
        'Plassering i søkemønster',
        'Ta opp person fra vann',
        'Sleperutiner',
        'Sikker kommunikasjon'
      ]},
      { title:'Vedlikehold', items:[
        'Etter-skylling og konservering',
        'Brensel & olje-kontroll',
        'Transport på henger',
        'Lagring og sikring'
      ]},
    ]
  };

  // ---- Bygg "katalog" med id’er (så det ligner ekte data) ----
  let catalog = {};
  let autoId = 1;
  for(const role of ROLES){
    catalog[role] = DEMO[role].map(sec=>{
      const items = sec.items.map(txt=>({ id: (autoId++).toString(), text: txt }));
      return { id: 's'+(autoId++), title: sec.title, items };
    });
  }

  // ---- State + lagring ----
  const KEY = 'mannskapsbok_demo_v1';
  let progress = load() || {};           // { itemId: {done,date,signed_by} }
  const saveQ = new Map();
  let idle = null;

  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{ return {}; } }
  function persist(){
    const obj = { ...progress, ...Object.fromEntries(saveQ.entries()) };
    localStorage.setItem(KEY, JSON.stringify(obj));
    progress = obj; saveQ.clear(); updateSavebar(); toast('Lagret ✅');
    renderCards(); // oppdater tellerne
  }

  function queue(itemId, patch){
    const cur = progress[itemId] || {};
    saveQ.set(itemId, { ...cur, ...patch });
    updateSavebar();
    schedule();
  }
  function schedule(){ clearTimeout(idle); idle = setTimeout(persist, 1500); }

  // ---- UI helpers ----
  const $ = (s,r=document)=>r.querySelector(s);
  function clsFor(done,total){ if(total===0 || done===0) return 'gray'; if(done<total) return 'yellow'; return 'green'; }
  function fmt(v){ return v??''; }
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }

  // ---- Render kort (oversikt) ----
  function renderCards(){
    const grid = $('#cards'); grid.innerHTML='';
    ROLES.forEach(role=>{
      const its = (catalog[role]||[]).flatMap(s=>s.items);
      const total = its.length;
      const done = its.filter(it => (progress[it.id]||saveQ.get(it.id)||{}).done).length;
      const card = document.createElement('div'); card.className='card';
      const btn  = document.createElement('button'); btn.className = clsFor(done,total);
      btn.innerHTML = `${role}<span class="sub">${done}/${total} fullført</span>`;
      btn.onclick = ()=>{ renderTabs(role); renderRole(role); };
      card.appendChild(btn); grid.appendChild(card);
    });
  }

  // ---- Tabs ----
  function renderTabs(active){
    const tabs = $('#tabs'); tabs.innerHTML='';
    ROLES.forEach(r=>{
      const b=document.createElement('button'); b.className='tab'+(r===active?' active':''); b.textContent=r;
      b.onclick=()=>{ renderTabs(r); renderRole(r); };
      tabs.appendChild(b);
    });
  }

  // ---- Panel for valgt rolle ----
  function renderRole(role){
    const panel = $('#panel'); const secs = catalog[role]||[];
    if(!secs.length){ panel.innerHTML = '<div class="empty">Ingen punkter.</div>'; return; }

    panel.innerHTML = secs.map((s,si)=>`
      <div style="margin:10px 0 14px">
        <div class="tag">${s.title}</div>
        <table class="table">
          <thead><tr><th style="width:66px">#</th><th>Beskrivelse</th><th style="width:140px">Dato</th><th style="width:180px">Signert</th><th style="width:80px">Ferdig</th></tr></thead>
          <tbody>
            ${s.items.map((it,pi)=>{
              const pr = saveQ.get(it.id) || progress[it.id] || {};
              return `
                <tr data-id="${it.id}">
                  <td>${si+1}.${pi+1}</td>
                  <td>${it.text.replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}</td>
                  <td><input type="date" value="${fmt(pr.date)}"></td>
                  <td><input type="text" placeholder="Signert av" value="${fmt(pr.signed_by||'')}"></td>
                  <td><input type="checkbox" ${pr.done?'checked':''}></td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    `).join('');

    // bind inputs
    panel.querySelectorAll('tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const c  = tr.querySelector('input[type="checkbox"]');
      function commit(){
        if(c.checked && !d.value){ d.value = new Date().toISOString().slice(0,10); }
        queue(id,{ date: d.value||null, signed_by: s.value||null, done: !!c.checked });
      }
      d.addEventListener('change', commit);
      s.addEventListener('change', commit);
      c.addEventListener('change', commit);
    });
  }

  // ---- Savebar ----
  function updateSavebar(){
    const bar = $('#savebar');
    const n = saveQ.size;
    if(n>0){ bar.style.display='flex'; $('#savecount').textContent = `${n} endringer`; $('#savemsg').textContent = 'Endringer ikke lagret.'; }
    else { bar.style.display='none'; }
  }
  $('#savebtn').onclick = persist;

  // start
  renderCards();
  renderTabs(ROLES[0]);
  renderRole(ROLES[0]);
})();
</script>
</body>
</html>
