<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mannskapsbok</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--rcb-accent:#2b4dcb}
    body{margin:0;font-family:Arial,sans-serif;background:#fafafa}
    .rcb-wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .rcb-title{font-size:28px;font-weight:800;color:var(--rcb-accent);margin-bottom:12px}
    .rcb-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .rcb-badge{padding:4px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;font-size:12px}
    .rcb-btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .rcb-btn.primary{background:#111;color:#fff;border-color:#111}
    .rcb-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:16px 0 8px}
    .rcb-card{border:1px solid #eee;border-radius:12px;background:#f7f7f7}
    .rcb-card button{width:100%;padding:14px;font-weight:700;border:0;border-radius:12px;cursor:pointer}
    .gray{background:#e5e5e5}.yellow{background:#ffe08a}.green{background:#9be29b}
    .rcb-card .sub{display:block;font-weight:400;font-size:12px;opacity:.85;margin-top:2px}
    .rcb-tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .rcb-tab{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .rcb-tab.active{background:#111;color:#fff}
    .rcb-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .rcb-table th,.rcb-table td{border-bottom:1px solid #eee;padding:6px;text-align:left;font-size:14px}
    .rcb-table th{background:#fafafa}
    .rcb-empty{padding:16px;color:#666}
    #rcbOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:1000}
    #rcbOverlay.open{display:flex}
    #rcbWrap{width:min(500px,90%);background:#fff;border-radius:12px;padding:20px}
    #rcbWrap input{display:block;width:100%;padding:10px;margin:6px 0;border:1px solid #ddd;border-radius:8px}
    .note{font-size:12px;color:#555}
  </style>
</head>
<body>
<div id="app" class="rcb-wrap"></div>

<div id="rcbOverlay">
  <div id="rcbWrap">
    <h3>Logg inn</h3>
    <input id="email" type="email" placeholder="din@epost.no">
    <input id="otp" type="text" maxlength="6" placeholder="6-sifret kode (valgfritt)">
    <div id="msg" class="note"></div>
    <button id="send" class="rcb-btn primary">Send lenke</button>
    <button id="check" class="rcb-btn">Sjekk innlogging</button>
    <button id="verify" class="rcb-btn">Verifiser kode</button>
  </div>
</div>

<script>
(async()=>{
  // === Supabase-konfig ===
  const SUPABASE_URL  = "https://pmrkhwpshbnnbjfkslyw.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtcmtod3BzaGJubmJqZmtzbHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNDEyODAsImV4cCI6MjA3MTYxNzI4MH0.NKaeyjbEoSsJ1mHRUMyclkbdWx5ClylaILNjr1l3Tas";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const ROLES=["Fartøysjef","NK","Matros","Aspirant","Rescuerunner"];
  let me=null; let catalog={}; let progress={};

  const $=(s,r=document)=>r.querySelector(s);
  const esc=s=>(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const chipCls=(done,total)=> total===0||done===0?"gray":(done<total?"yellow":"green");

  function openOverlay(){ $('#rcbOverlay').classList.add('open'); }
  function closeOverlay(){ $('#rcbOverlay').classList.remove('open'); }

  async function gate(){
    const {data:{session}}=await sb.auth.getSession();
    if(!session){ openOverlay(); return false; }
    me=session.user;
    await sb.from("profiles").upsert({id:me.id,email:me.email},{onConflict:"id"});
    return true;
  }

  async function loadCatalog(){
    catalog={};
    for(const role of ROLES){
      const {data:secs}=await sb.from("sections").select("id,title,position").eq("role",role).order("position");
      const list=[];
      for(const s of secs||[]){
        const {data:its}=await sb.from("items").select("id,text,position").eq("section_id",s.id).order("position");
        list.push({id:s.id,title:s.title,items:its||[]});
      }
      catalog[role]=list;
    }
  }
  async function loadProgress(){
    const {data}=await sb.from("progress").select("item_id,done,date,signed_by").eq("user_id",me.id);
    progress={}; (data||[]).forEach(r=>progress[r.item_id]=r);
  }
  async function saveProgress(itemId,row){
    row.user_id=me.id; row.item_id=itemId;
    await sb.from("progress").upsert(row,{onConflict:"user_id,item_id"});
  }

  function render(){
    const host=$("#app");
    host.innerHTML=`<div class="rcb-title">Mannskapsbok</div>
      <div class="rcb-row"><span>Innlogget som <b>${esc(me.email)}</b></span>
        <button id="logout" class="rcb-btn">Logg ut</button>
      </div>
      <div class="rcb-grid" id="cards"></div>
      <div class="rcb-tabs" id="tabs"></div>
      <div id="panel"></div>`;

    $("#logout").onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

    renderCards(); renderTabs(ROLES[0]); renderRole(ROLES[0]);
  }

  function renderCards(){
    const grid=$("#cards"); grid.innerHTML="";
    ROLES.forEach(r=>{
      const items=(catalog[r]||[]).flatMap(s=>s.items);
      const total=items.length; const done=items.filter(it=>progress[it.id]?.done).length;
      const card=document.createElement("div");card.className="rcb-card";
      const btn=document.createElement("button");btn.className=chipCls(done,total);
      btn.innerHTML=`${r}<span class="sub">${done}/${total} fullført</span>`;
      btn.onclick=()=>{renderTabs(r);renderRole(r)};
      card.appendChild(btn);grid.appendChild(card);
    });
  }

  function renderTabs(active){
    const tabs=$("#tabs");tabs.innerHTML="";
    ROLES.forEach(r=>{
      const b=document.createElement("button");b.className="rcb-tab"+(r===active?" active":"");b.textContent=r;
      b.onclick=()=>{renderTabs(r);renderRole(r)};tabs.appendChild(b);
    });
  }

  function renderRole(role){
    const panel=$("#panel");
    const secs=catalog[role]||[]; if(!secs.length){panel.innerHTML="<div class='rcb-empty'>Ingen punkter</div>";return;}
    panel.innerHTML=secs.map((s,si)=>`
      <div><div class="rcb-badge">${esc(s.title)}</div>
      <table class="rcb-table"><thead><tr><th>#</th><th>Beskrivelse</th><th>Dato</th><th>Signert</th><th>Ferdig</th></tr></thead>
      <tbody>${s.items.map((it,pi)=>`
        <tr data-id="${it.id}">
          <td>${si+1}.${pi+1}</td><td>${esc(it.text)}</td>
          <td><input type="date" value="${progress[it.id]?.date||""}"></td>
          <td><input type="text" value="${esc(progress[it.id]?.signed_by||"")}" placeholder="Signert av"></td>
          <td><input type="checkbox" ${progress[it.id]?.done?"checked":""}></td>
        </tr>`).join("")}</tbody></table></div>`).join("");
    panel.querySelectorAll("tbody tr").forEach(tr=>{
      const id=tr.getAttribute("data-id");
      const d=tr.querySelector("input[type=date]"),s=tr.querySelector("input[type=text]"),c=tr.querySelector("input[type=checkbox]");
      function commit(){ if(c.checked && !d.value) d.value=new Date().toISOString().slice(0,10);
        saveProgress(id,{done:c.checked,date:d.value||null,signed_by:s.value||null}); renderCards(); }
      d.onchange=commit; s.onchange=commit; c.onchange=commit;
    });
  }

  // Overlay-knapper
  $("#send").onclick=async()=>{
    const email=$("#email").value.trim();
    const {error}=await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } });
    $("#msg").textContent=error?error.message:"Lenke sendt!";
  };
  $("#verify").onclick=async()=>{
    const email=$("#email").value.trim();
    const otp=$("#otp").value.trim();
    const {error}=await sb.auth.verifyOtp({type:"email",email,token:otp});
    $("#msg").textContent=error?error.message:"Innlogget!"; if(!error) location.reload();
  };
  $("#check").onclick=()=>location.reload();

  // Start app
  if(await gate()){ closeOverlay(); await loadCatalog(); await loadProgress(); render(); }
})();
</script>
</body>
</html>
