<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Depot med utstyr og dra-og-slipp</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 30px;
      background: #eef2f7;
      color: #333;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .btn {
      background: #1976d2;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
    }
    .btn:hover { background: #125ea9; }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h3 {
      margin: 0 0 15px 0;
      font-size: 20px;
      color: #1976d2;
    }

    .toggle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 6px;
      background: #f9f9f9;
      cursor: pointer;
    }
    .toggle-header:hover {
      background: #f0f0f0;
    }
    .hidden {
      display: none;
    }

    .utstyr-linje {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 6px;
      background: #fff;
      margin-left: 30px;
    }
    .utstyr-linje .info {
      display: flex;
      flex-direction: column;
    }
    .utstyr-linje .info .navn {
      font-weight: bold;
    }
    .utstyr-linje .info .status {
      font-size: 12px;
      color: #666;
    }

    .badge {
      background: #e53935; /* r√∏dt */
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 10px;
    }

    .alt-ok-btn {
      background: #4CAF50; /* gr√∏nn */
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 5px;
    }
    .slett-btn {
      background: #888;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 13px;
    }

    .handle {
      cursor: grab;
      margin-right: 8px;
      font-size: 16px;
    }

  </style>
</head>
<body>

  <div class="top-bar">
    <button class="btn" onclick="window.location.href='index.html'">‚Üê Tilbake</button>
    <div>
      <button class="btn" onclick="toggleEditMode()">üõ†Ô∏è Rediger</button>
      <button class="btn" onclick="lagreStruktur()">üíæ Lagre</button>
    </div>
  </div>

  <div id="cardsContainer"></div>

  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <script>
    let editMode = false;
    const STORAGE_KEY = "depotStructDrag";
    const DATE_KEY_PREFIX = "lastChecked_";

    let structure = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [
      {
        id: "ov1",
        navn: "Oversikt A",
        utstyr: [],
        undermeny: [
          {
            id: "u1",
            navn: "Undermeny 1",
            utstyr: ["O2-kolbe, 5 liter"],
            undermeny: [
              {
                id: "u2",
                navn: "Undermeny 2",
                utstyr: [],
                undermeny: []
              }
            ]
          }
        ]
      }
    ];

    function toggleEditMode() {
      editMode = !editMode;
      renderCards();
    }

    function lagreStruktur() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(structure));
      alert("Struktur lagret!");
      editMode = false;
      renderCards();
    }

    function lagreSjekk(id) {
      const now = new Date().toISOString();
      localStorage.setItem(DATE_KEY_PREFIX + id, now);
      renderCards();
    }

    function dagerSiden(id) {
      const datoStr = localStorage.getItem(DATE_KEY_PREFIX + id);
      if (!datoStr) return "‚Äì";
      const dato = new Date(datoStr);
      const n√• = new Date();
      const diff = Math.floor((n√• - dato) / (1000 * 60 * 60 * 24));
      return diff === 0 ? "I dag" : `${diff} dager`;
    }

    // Funksjon for √• lage draggable p√• en list
    function makeSortable(container, levelArr) {
      // levelArr er array med referanser til objektene i structure p√• det niv√•et
      new Sortable(container, {
        handle: '.handle',
        animation: 150,
        fallbackOnBody: true,
        swapThreshold: 0.65,
        onEnd: function(evt) {
          // evt.oldIndex, evt.newIndex
          const { oldIndex, newIndex } = evt;
          // flytt objektene i levelArr
          const moved = levelArr.splice(oldIndex, 1)[0];
          levelArr.splice(newIndex, 0, moved);
          lagreStruktur();
        }
      });
    }

    function renderUndermeny(items, parent, level = 1) {
      const listContainer = document.createElement("div");
      listContainer.style.marginLeft = `${level * 20}px`;
      parent.appendChild(listContainer);

      // gj√∏r hele items listen sortable
      makeSortable(listContainer, items);

      items.forEach((item, i) => {
        const wrapper = document.createElement("div");

        const header = document.createElement("div");
        header.className = "toggle-header";

        // handle for drag
        const handle = document.createElement("span");
        handle.className = "handle";
        handle.textContent = "‚ò∞";
        header.appendChild(handle);

        // navn + badge
        const left = document.createElement("div");
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = dagerSiden(item.id);
        left.appendChild(badge);
        if (editMode) {
          const input = document.createElement("input");
          input.value = item.navn;
          input.onchange = e => {
            item.navn = e.target.value;
          };
          header.appendChild(left);
          header.appendChild(input);
        } else {
          left.appendChild(document.createTextNode(item.navn));
          header.appendChild(left);
        }

        // knapper til h√∏yre
        const right = document.createElement("div");
        if (editMode) {
          const delBtn = document.createElement("button");
          delBtn.className = "slett-btn";
          delBtn.textContent = "X";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            items.splice(i,1);
            renderCards();
          };
          right.appendChild(delBtn);
        }

        const okBtn = document.createElement("button");
        okBtn.className = "alt-ok-btn";
        okBtn.textContent = "‚úîÔ∏è";
        okBtn.onclick = (e) => {
          e.stopPropagation();
          lagreSjekk(item.id);
        };
        right.appendChild(okBtn);

        header.appendChild(right);

        wrapper.appendChild(header);

        // Innhold som skjules / vises
        const content = document.createElement("div");
        content.className = editMode ? "" : "hidden";

        // Utstyrsliste
        const utstyrList = document.createElement("div");
        (item.utstyr || []).forEach((u, ui) => {
          const line = document.createElement("div");
          line.className = "utstyr-linje";

          const info = document.createElement("div");
          info.className = "info";

          const navnSpan = document.createElement("span");
          navnSpan.className = "navn";
          navnSpan.textContent = u;
          info.appendChild(navnSpan);

          const statusSpan = document.createElement("span");
          statusSpan.className = "status";
          statusSpan.textContent = "Til stede og niv√•"; // du kan endre til dynamisk
          info.appendChild(statusSpan);

          line.appendChild(info);

          const btnRight = document.createElement("div");
          const okU = document.createElement("button");
          okU.className = "alt-ok-btn";
          okU.textContent = "‚úîÔ∏è";
          okU.onclick = (e) => {
            e.stopPropagation();
            lagreSjekk(item.id + "_utstyr_" + ui);
          };
          btnRight.appendChild(okU);

          const delU = document.createElement("button");
          delU.className = "slett-btn";
          delU.textContent = "X";
          delU.onclick = (e) => {
            e.stopPropagation();
            item.utstyr.splice(ui,1);
            renderCards();
          };
          btnRight.appendChild(delU);

          line.appendChild(btnRight);
          utstyrList.appendChild(line);
        });

        if (editMode) {
          const btnLeggTilUtstyr = document.createElement("button");
          btnLeggTilUtstyr.className = "btn";
          btnLeggTilUtstyr.textContent = "‚ûï Legg til utstyr";
          btnLeggTilUtstyr.onclick = (e) => {
            e.stopPropagation();
            const navn = prompt("Navn p√• utstyr:");
            if (navn) {
              if (!item.utstyr) item.utstyr = [];
              item.utstyr.push(navn);
              renderCards();
            }
          };
          content.appendChild(btnLeggTilUtstyr);
        }

        // Legg til undermenyer rekursivt
        if (item.undermeny && item.undermeny.length > 0) {
          renderUndermeny(item.undermeny, content, level + 1);
        }

        wrapper.appendChild(content);
        listContainer.appendChild(wrapper);

        // klikk for √• toggle visning
        header.onclick = () => {
          content.classList.toggle("hidden");
        };
      });
    }

    function renderCards() {
      const cont = document.getElementById("cardsContainer");
      cont.innerHTML = "";

      structure.forEach((oversikt, oi) => {
        const card = document.createElement("div");
        card.className = "card";

        const h3 = document.createElement("h3");
        if (editMode) {
          const input = document.createElement("input");
          input.value = oversikt.navn;
          input.onchange = e => oversikt.navn = e.target.value;
          h3.appendChild(input);

          const delBtn = document.createElement("button");
          delBtn.className = "slett-btn";
          delBtn.textContent = "X";
          delBtn.onclick = () => {
            structure.splice(oi,1);
            renderCards();
          };
          h3.appendChild(delBtn);
        } else {
          h3.textContent = oversikt.navn;
        }

        card.appendChild(h3);

        // gj√∏r oversikt.undermeny draggable/visbar
        if (oversikt.undermeny) {
          renderUndermeny(oversikt.undermeny, card, 0);
        }

        if (editMode) {
          const btnAdd = document.createElement("button");
          btnAdd.className = "btn";
          btnAdd.textContent = "‚ûï Legg til undermeny";
          btnAdd.onclick = () => {
            const navn = prompt("Navn p√• ny undermeny:");
            if (navn) {
              oversikt.undermeny.push({ id: "u" + Date.now(), navn, utstyr: [], undermeny: [] });
              renderCards();
            }
          };
          card.appendChild(btnAdd);
        }

        cont.appendChild(card);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderCards();
    });

  </script>

</body>
</html>
