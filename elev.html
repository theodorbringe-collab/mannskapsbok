<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mannskapsbok ‚Äì Elev</title>
  <link rel="stylesheet" href="./assets/styles.css?v=otp9">
  <style>
    /* side-spesifikt */
    .top-actions{display:flex;gap:8px;justify-content:center;margin:10px 0 6px}
    .name-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .name-left{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}

    /* enkel modal for eksempel-tekst */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.48);display:none;align-items:center;justify-content:center;z-index:60}
    .modal.open{display:flex}
    .modal-card{width:min(720px,92vw);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .modal-hd{padding:14px 16px;background:#f8fafc;border-bottom:1px solid var(--line);font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .modal-bd{padding:14px 16px;white-space:pre-wrap}
  </style>
</head>
<body>

<!-- Isolert R√∏de-Kors header -->
<div class="rk-header">
  <div class="wrap rk-head-inner">
    <div class="rk-logo"></div>
    <div class="rk-title">R√∏de Kors<span class="rk-sub">B√•ten Bj√∏rgvin</span></div>
  </div>
</div>
<nav class="rk-nav">
  <div class="wrap">
    <a href="./elev.html">Hovedmeny</a>
  </div>
</nav>

<div class="wrap" id="app">Laster ‚Ä¶</div>

<!-- Eksempel-modal (visning) -->
<div class="modal" id="exModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="exTitle">
    <div class="modal-hd">
      <span id="exTitle">Eksempel / forklaring</span>
      <button id="exClose" class="btn small">Lukk</button>
    </div>
    <div id="exBody" class="modal-bd"></div>
  </div>
</div>

<script type="module">
import {
  sb, ROLES,
  ensureUserOrRedirect, updateProfile, signOut,
  loadCatalog, loadMyProgress, upsertProgress
} from "./assets/common.js?v=otp7";

(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const today=()=>new Date().toISOString().slice(0,10);

  // √∏nsket rekkef√∏lge + korte etiketter
  const ROLE_ORDER = ['Fart√∏ysjef','NK','Matros','Rescuerunner','Aspirant'];
  const SHORT = { Fart√∏ysjef:'FS', NK:'NK', Matros:'Matros', Rescuerunner:'Rescuerunner', Aspirant:'Aspirant' };

  let me=null, catalog={}, myProg=new Map(), activeRole=ROLE_ORDER[0], rt=null;

  function lastUpdated(){
    let d=null;
    for(const v of myProg.values()){
      if(v?.date){ const t=new Date(v.date); if(!d || t>d) d=t; }
    }
    return d ? d.toLocaleDateString('no-NO') : '‚Äî';
  }

  async function init(){
    try{
      me = await ensureUserOrRedirect();               // üîê ekte login
      const [cat, prog] = await Promise.all([loadCatalog(), loadMyProgress(me.id)]);
      catalog = cat; myProg = prog;
      render();
      bindRealtime();
      bindExampleModal();
    }catch(e){
      $("#app").innerHTML = `<div class="box"><div class="hd">Feil</div><div class="bd" style="color:#b00020">${esc(e.message||e)}</div></div>`;
      console.error(e);
    }
  }

  function render(){
    $("#app").innerHTML = `
      <div class="page page-narrow">
        <h1 style="text-align:center;margin-bottom:6px">Mannskapsbok</h1>

        <div class="top-actions">
          <button id="btnSave" class="btn">Lagre</button>
          <a class="btn" href="./admin.html">Admin</a>
          <button id="btnLogout" class="btn">Logg ut</button>
        </div>

        <div class="box" style="margin-bottom:12px">
          <div class="bd">
            <div class="name-row">
              <div class="name-left">
                <span class="note">Navn</span>
                <b id="meName">${esc(me.name || '(sett navn)')}</b>
                <span class="note">‚Ä¢ ${esc(me.email||'')}</span>
              </div>
              <span class="note">Sist oppdatert: <b id="lastUpd">${lastUpdated()}</b></span>
            </div>
            <div class="row" style="gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap">
              <input id="ownerName"  class="field" placeholder="Fullt navn" value="${esc(me.name||'')}"  style="max-width:240px">
              <input id="ownerEmail" class="field" placeholder="E-post"     value="${esc(me.email||'')}" style="max-width:260px">
              <button id="saveOwner" class="btn">Oppdater</button>
            </div>
            <div class="note" style="text-align:center;margin-top:6px">Skriv inn fullt navn. E-post kan ogs√• endres ved behov.</div>
          </div>
        </div>

        <!-- ROLLE-STRIPE (horisontal) -->
        <div id="roleBar" class="rolebar roles-strip"></div>

        <div id="panel"></div>
      </div>
    `;

    $('#btnSave').onclick = ()=> toast('Lagret ‚úÖ');
    $('#btnLogout').onclick = async ()=>{
      await signOut(); location.replace('./login.html');
    };
    $('#saveOwner').onclick = async ()=>{
      try{
        const name = $('#ownerName').value.trim();
        const email = $('#ownerEmail').value.trim();
        if(!name){ alert('Skriv inn fullt navn.'); return; }
        await updateProfile({ name, email });
        me = await ensureUserOrRedirect();
        $('#meName').textContent = me.name || '(sett navn)';
        toast('Oppdatert');
      }catch(e){ alert('Kunne ikke oppdatere: ' + (e.message||e)); }
    };

    drawRoleBar();
    drawRole(activeRole);
  }

  function drawRoleBar(){
    const host=$('#roleBar'); host.innerHTML='';
    const roles = ROLE_ORDER.filter(r=>ROLES.includes(r));
    roles.forEach(role=>{
      const b=document.createElement('button');
      b.className=`rolebtn ${role===activeRole?'active':''}`;
      b.textContent = SHORT[role] || role;
      b.onclick=()=>{ activeRole=role; drawRoleBar(); drawRole(activeRole); };
      host.appendChild(b);
    });
  }

  function drawRole(role){
    const panel=$("#panel"); const secs=catalog[role]||[];
    if(!secs.length){ panel.innerHTML='<div class="box"><div class="bd">Ingen punkter.</div></div>'; return; }

    // map for raskt oppslag av eksempel-tekst
    const itemsMap = new Map();
    secs.forEach(s=>s.items.forEach(it=> itemsMap.set(String(it.id), it)));

    panel.innerHTML = secs.map((s,si)=>`
      <div class="box" style="margin-bottom:12px">
        <div class="hd">${esc(s.title)}</div>
        <div class="bd">
          <table class="mb-table">
            <thead>
              <tr>
                <th style="width:56px">#</th>
                <th>Jeg kan dette</th>
                <th style="width:260px">Sjekket ut av</th>
                <th style="width:160px">Dato</th>
                <th style="width:90px">Avkryss</th>
              </tr>
            </thead>
            <tbody>
              ${s.items.map((it,pi)=>{
                const pr=myProg.get(String(it.id))||{};
                const exBtn = it.has_example ? `<button class="btn small" data-ex="1" title="Vis eksempel">Eksempel</button>` : '';
                return `<tr data-id="${String(it.id)}">
                  <td>${si+1}.${pi+1}</td>
                  <td>${esc(it.text)}</td>
                  <td>
                    <div class="row" style="gap:8px;align-items:center">
                      <input class="field" type="text" value="${esc(pr.signed_by||'')}" placeholder="Skriv inn navn" style="width:100%">
                      ${exBtn}
                    </div>
                  </td>
                  <td><input class="field" type="date" value="${pr.date||''}" style="min-width:140px"></td>
                  <td style="text-align:center">
                    <button class="mini-check" data-done="${pr.done?1:0}" title="${pr.done?'Fullf√∏rt':'Ikke fullf√∏rt'}" aria-pressed="${pr.done?true:false}">‚úì</button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `).join('');

    // handlers
    $$('#panel tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const b  = tr.querySelector('.mini-check');
      const ex = tr.querySelector('button[data-ex]');

      async function commit(action=null){
        let done = !!myProg.get(id)?.done;
        if(action==='toggle'){ done=!done; if(done && !d.value) d.value=today(); if(!done) d.value=''; }
        try{
          await upsertProgress(id,{ date:d.value||null, signed_by:(s.value||null), done }, me.id);
          myProg.set(id,{ item_id:id, date:d.value||null, signed_by:s.value||null, done });

          // visuell oppdatering
          b.setAttribute('data-done', done ? '1' : '0');
          b.setAttribute('aria-pressed', done ? 'true' : 'false');
          b.title = done ? 'Fullf√∏rt' : 'Ikke fullf√∏rt';
          b.classList.add('flash'); setTimeout(()=>b.classList.remove('flash'), 220);

          $('#lastUpd').textContent = lastUpdated();
        }catch(e){
          alert('Kunne ikke lagre: ' + (e.message||e));
        }
      }
      s.onchange=()=>commit();
      d.onchange=()=>commit();
      b.onclick =()=>commit('toggle');

      if(ex){
        ex.onclick = ()=>{
          const it = itemsMap.get(id);
          openExampleModal(it?.example_text || '', it?.text || 'Eksempel / forklaring');
        };
      }
    });
  }

  // liten toast
  function toast(msg){
    let t=document.getElementById('toast');
    if(!t){ t=document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
    t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
  }

  // Eksempel-modal
  function bindExampleModal(){
    $('#exClose').onclick = closeExampleModal;
    $('#exModal').addEventListener('click', (e)=>{
      if(e.target === $('#exModal')) closeExampleModal(); // klikk utenfor kortet
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && $('#exModal').classList.contains('open')) closeExampleModal();
    });
  }
  function openExampleModal(text, title){
    $('#exTitle').textContent = title;
    $('#exBody').textContent  = text || '‚Äî';
    $('#exModal').classList.add('open');
  }
  function closeExampleModal(){
    $('#exModal').classList.remove('open');
  }

  function bindRealtime(){
    if(rt){ sb.removeChannel(rt); rt=null; }
    rt = sb.channel('mb-live-elev')
      .on('postgres_changes',{event:'*',schema:'public',table:'progress',filter:`user_id=eq.${me.id}`},
        async()=>{ myProg=await loadMyProgress(me.id); drawRole(activeRole); $('#lastUpd').textContent=lastUpdated(); })
      .on('postgres_changes',{event:'*',schema:'public',table:'sections'},
        async()=>{ catalog=await loadCatalog(); drawRole(activeRole); })
      .on('postgres_changes',{event:'*',schema:'public',table:'items'},
        async()=>{ catalog=await loadCatalog(); drawRole(activeRole); })
      .subscribe();
  }

  init();
})();
</script>
</body>
</html>
