<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mannskapsbok – Elev</title>
  <link rel="stylesheet" href="./assets/styles.css?v=auth1">
  <style>
    .rk-header{background:#fff;border-bottom:1px solid #eaeaea}
    .rk-head-inner{display:flex;align-items:center;gap:14px;padding:10px 0}
    .rk-logo{position:relative;width:42px;height:42px;flex:0 0 42px}
    .rk-logo::before,.rk-logo::after{content:"";position:absolute;background:#ff1a1a;border-radius:2px}
    .rk-logo::before{width:70%;height:26%;left:15%;top:37%}
    .rk-logo::after{width:26%;height:70%;left:37%;top:15%}
    .rk-title{font-size:28px;font-weight:800;letter-spacing:.2px;color:#000}
    .rk-title .rk-sub{font-weight:600;margin-left:.25em}
    .rk-nav{background:#ff1a1a}
    .rk-nav .wrap{display:flex;gap:12px;padding:6px 0;font-weight:700}
    .rk-nav a{color:#fff;text-decoration:none}
    .rk-nav a:hover{text-decoration:underline}
    .rk-header + .rk-nav + .wrap{margin-top:16px}
  </style>
</head>
<body>

<div class="rk-header">
  <div class="wrap rk-head-inner">
    <div class="rk-logo"></div>
    <div class="rk-title">Røde Kors<span class="rk-sub">Båten Bjørgvin</span></div>
  </div>
</div>
<nav class="rk-nav">
  <div class="wrap">
    <a href="./elev.html">Hovedmeny</a>
  </div>
</nav>

<div class="wrap" id="app">Laster …</div>

<script type="module">
import {
  sb, ROLES,
  ensureUserOrRedirect, updateProfile,
  loadCatalog, loadMyProgress, upsertProgress
} from "./assets/common.js?v=auth1";

(function(){
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const esc=s=>(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const today=()=>new Date().toISOString().slice(0,10);
  const clsFor=(done,total)=> total===0||done===0?'gray':(done<total?'yellow':'green');

  let me=null, catalog={}, myProg=new Map(), activeRole=ROLES[0], rt=null;

  function lastUpdated(){
    let d=null;
    for(const v of myProg.values()){
      if(v?.date){ const t=new Date(v.date); if(!d || t>d) d=t; }
    }
    return d ? d.toLocaleDateString('no-NO') : '—';
  }

  async function init(){
    try{
      me = await ensureUserOrRedirect();              // ← krever innlogging
      const [cat, prog] = await Promise.all([loadCatalog(), loadMyProgress(me.id)]);
      catalog = cat; myProg = prog;
      render();
      bindRealtime();
    }catch(e){
      // Redirecter til login hvis ikke innlogget
    }
  }

  function render(){
    $("#app").innerHTML = `
      <h1>Mannskapsbok</h1>

      <div class="row" style="margin-bottom:10px">
        <button id="btnSave" class="btn">Lagre</button>
        <a class="btn" href="./admin.html?v=auth1">Admin</a>
        <span class="note" style="margin-left:auto">Sist oppdatert: <b id="lastUpd">${lastUpdated()}</b></span>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div class="bd">
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <div><span class="note">Navn</span><div><b id="meName">${esc(me.name||me.email)}</b></div></div>
            <div class="row" style="gap:8px">
              <input id="ownerName"  class="field" placeholder="Endre navn"  value="${esc(me.name||'')}"  style="max-width:220px">
              <input id="ownerEmail" class="field" placeholder="Endre e-post" value="${esc(me.email||'')}" style="max-width:240px">
              <button id="saveOwner" class="btn">Oppdater</button>
            </div>
          </div>
        </div>
      </div>

      <div id="roleBar" class="rolebar"></div>

      <div id="panel"></div>
    `;

    $('#btnSave').onclick=()=> toast('Lagret ✅');
    $('#saveOwner').onclick=async()=>{
      const name=$('#ownerName').value.trim(), email=$('#ownerEmail').value.trim();
      try{
        await updateProfile({ name, email });
        me = await ensureUserOrRedirect();
        $('#meName').textContent = me.name||me.email;
        toast('Oppdatert');
      }catch(e){
        alert('Kunne ikke oppdatere profil: ' + (e.message||e));
      }
    };

    drawRoleBar();
    drawRole(activeRole);
  }

  function drawRoleBar(){
    const host=$('#roleBar'); host.innerHTML='';
    ROLES.forEach(role=>{
      const its=(catalog[role]||[]).flatMap(s=>s.items);
      const total=its.length;
      const done=its.filter(it=>myProg.get(String(it.id))?.done).length;
      const b=document.createElement('button');
      b.className=`rolebtn ${clsFor(done,total)}`;
      b.innerHTML = `${role}<span class="sub">${done}/${total} fullført</span>`;
      b.onclick=()=>{ activeRole=role; drawRole(activeRole); };
      host.appendChild(b);
    });
  }

  function drawRole(role){
    const panel=$("#panel"); const secs=catalog[role]||[];
    if(!secs.length){ panel.innerHTML='<div class="box"><div class="bd">Ingen punkter.</div></div>'; return; }

    panel.innerHTML = secs.map((s,si)=>`
      <div class="box" style="margin-bottom:10px">
        <div class="hd">${esc(s.title)}</div>
        <div class="bd">
          <table>
            <thead>
              <tr>
                <th style="width:60px">#</th>
                <th>Jeg kan dette</th>
                <th style="width:220px">Sjekket ut av</th>
                <th style="width:170px">Dato</th>
              </tr>
            </thead>
            <tbody>
              ${s.items.map((it,pi)=>{
                const key = String(it.id||"");
                const pr  = myProg.get(key)||{};
                return `<tr data-id="${key}">
                  <td>${si+1}.${pi+1}</td>
                  <td>${esc(it.text)}</td>
                  <td><input class="field" type="text" value="${esc(pr.signed_by||'')}" placeholder="Skriv inn navn"></td>
                  <td class="datecell">
                    <input class="field" type="date" value="${pr.date||''}">
                    <button class="mini-check" data-done="${pr.done?1:0}" title="Avkrysset">✓</button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `).join('');

    // handlers
    $$('#panel tbody tr').forEach(tr=>{
      const id = tr.getAttribute('data-id') || "";
      const d  = tr.querySelector('input[type="date"]');
      const s  = tr.querySelector('input[type="text"]');
      const b  = tr.querySelector('.mini-check');

      async function commit(action=null){
        if(!id){ alert("Dette punktet mangler item_id."); return; }
        let done = !!myProg.get(id)?.done;
        if(action==='toggle'){ done=!done; if(done && !d.value) d.value=today(); if(!done) d.value=''; }

        // visuell feedback umiddelbart
        b.setAttribute('data-done', done ? '1' : '0');

        try{
          await upsertProgress(id,{ date:d.value||null, signed_by:(s.value||null), done }, me.id);
          myProg.set(id,{ item_id:id, date:d.value||null, signed_by:s.value||null, done });
          drawRoleBar();
          $('#lastUpd').textContent = lastUpdated();
        }catch(e){
          b.setAttribute('data-done', !done ? '1' : '0'); // rollback
          alert('Kunne ikke lagre: ' + (e.message||e));
        }
      }
      s.onchange=()=>commit();
      d.onchange=()=>commit();
      b.onclick =()=>commit('toggle');
    });
  }

  function toast(msg){
    let t=document.getElementById('toast');
    if(!t){ t=document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
    t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200);
  }

  function bindRealtime(){
    if(rt){ sb.removeChannel(rt); rt=null; }
    rt = sb.channel('mb-live-elev')
      .on('postgres_changes',{event:'*',schema:'public',table:'progress',filter:`user_id=eq.${me.id}`},
        async()=>{ myProg=await loadMyProgress(me.id); drawRoleBar(); drawRole(activeRole); $('#lastUpd').textContent=lastUpdated(); })
      .on('postgres_changes',{event:'*',schema:'public',table:'sections'},
        async()=>{ catalog=await loadCatalog(); drawRoleBar(); drawRole(activeRole); })
      .on('postgres_changes',{event:'*',schema:'public',table:'items'},
        async()=>{ catalog=await loadCatalog(); drawRoleBar(); drawRole(activeRole); })
      .subscribe();
  }

  init();
})();
</script>
</body>
</html>
